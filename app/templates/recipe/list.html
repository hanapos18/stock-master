{% extends "base.html" %}
{% block title %}Recipes - StockMaster{% endblock %}
{% block page_title %}Recipes{% endblock %}
{% block content %}
<div class="d-flex justify-content-between mb-3">
  <h5>Recipe List</h5>
  <div class="d-flex gap-2">
    <a href="{{ url_for('recipe.export_excel') }}" class="btn btn-outline-primary btn-sm"><i class="bi bi-file-earmark-arrow-down me-1"></i>Excel Export</a>
    <button class="btn btn-success btn-sm" data-bs-toggle="modal" data-bs-target="#excelUploadModal"><i class="bi bi-file-earmark-arrow-up me-1"></i>Excel Upload</button>
    <a href="{{ url_for('recipe.download_template') }}" class="btn btn-outline-success btn-sm"><i class="bi bi-download me-1"></i>Template</a>
    <a href="{{ url_for('recipe.create_recipe') }}" class="btn btn-primary btn-sm"><i class="bi bi-plus-circle me-1"></i>New Recipe</a>
  </div>
</div>
<div class="card border-0 shadow-sm"><div class="table-responsive">
  <table class="table table-hover mb-0"><thead class="table-light"><tr>
    <th>Menu Name</th><th>Yield</th><th>Ingredients</th><th>POS Link</th><th>Actions</th>
  </tr></thead><tbody>
    {% for r in recipes %}<tr>
      <td><strong>{{ r.name }}</strong></td>
      <td>{{ r.yield_quantity }} {{ r.yield_unit }}</td>
      <td>{{ r.ingredient_count }}</td>
      <td>{{ 'Linked' if r.pos_menu_id else 'Manual' }}</td>
      <td>
        <a href="{{ url_for('recipe.edit_recipe', recipe_id=r.id) }}" class="btn btn-sm btn-outline-primary">Edit</a>
        <button class="btn btn-sm btn-outline-info" onclick="showCost({{ r.id }})">Cost</button>
        <form method="post" action="{{ url_for('recipe.delete_recipe', recipe_id=r.id) }}" class="d-inline" onsubmit="return confirm('Deactivate?')"><button class="btn btn-sm btn-outline-danger">Delete</button></form>
      </td>
    </tr>{% endfor %}
    {% if not recipes %}<tr><td colspan="5" class="text-center text-muted py-3">No recipes</td></tr>{% endif %}
  </tbody></table>
</div></div>
<!-- Excel Upload Modal -->
<div class="modal fade" id="excelUploadModal" tabindex="-1"><div class="modal-dialog"><div class="modal-content">
  <div class="modal-header">
    <h5 class="modal-title"><i class="bi bi-file-earmark-excel text-success me-2"></i>Excel Recipe Upload</h5>
    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
  </div>
  <form method="post" action="{{ url_for('recipe.upload_excel') }}" enctype="multipart/form-data">
    <div class="modal-body">
      <div class="mb-3">
        <label class="form-label fw-bold">Select Excel File (.xlsx)</label>
        <input type="file" class="form-control" name="excel_file" accept=".xlsx,.xls" required>
      </div>
      <div class="alert alert-info small mb-0">
        <i class="bi bi-info-circle me-1"></i>
        <ul class="mb-0 mt-1">
          <li>Download <a href="{{ url_for('recipe.download_template') }}">Template</a> first</li>
          <li>Same Recipe Name = grouped as one recipe</li>
          <li>Product Code must match existing products</li>
          <li>Existing recipes (same name) will be <strong>updated</strong></li>
        </ul>
      </div>
    </div>
    <div class="modal-footer">
      <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
      <button type="submit" class="btn btn-success"><i class="bi bi-upload me-1"></i>Upload</button>
    </div>
  </form>
</div></div></div>
<div class="modal fade" id="costModal" tabindex="-1"><div class="modal-dialog"><div class="modal-content">
  <div class="modal-header"><h5 class="modal-title">Recipe Cost</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
  <div class="modal-body" id="costBody">Loading...</div>
</div></div></div>
{% endblock %}
{% block scripts %}
<script>
function showCost(id){
  document.getElementById('costBody').innerHTML='Loading...';
  new bootstrap.Modal(document.getElementById('costModal')).show();
  fetch('/recipes/'+id+'/cost').then(r=>r.json()).then(d=>{
    let html='<table class="table table-sm"><thead><tr><th>Ingredient</th><th>Qty</th><th>Cost</th></tr></thead><tbody>';
    d.items.forEach(i=>{html+='<tr><td>'+i.product_name+'</td><td>'+i.quantity+' '+(i.unit||'')+'</td><td>'+i.cost.toFixed(2)+'</td></tr>';});
    html+='</tbody><tfoot><tr class="fw-bold"><td colspan="2">Total Cost</td><td>'+d.total_cost.toFixed(2)+'</td></tr></tfoot></table>';
    document.getElementById('costBody').innerHTML=html;
  });
}
</script>
{% endblock %}
