{% extends "base.html" %}
{% block title %}Transaction History - Hana StockMaster{% endblock %}
{% block page_title %}Transaction History{% endblock %}
{% block content %}
<div class="d-flex gap-2 mb-3">
  <a href="{{ url_for('inventory.transactions') }}" class="btn btn-sm {{ 'btn-primary' if not selected_type else 'btn-outline-primary' }}">All</a>
  {% for t in ['in','out','adjust','discard','move','sale'] %}
  <a href="{{ url_for('inventory.transactions', type=t) }}" class="btn btn-sm {{ 'btn-primary' if selected_type==t else 'btn-outline-primary' }}">{{ t|upper }}</a>
  {% endfor %}
</div>
<div class="card border-0 shadow-sm">
  <div class="table-responsive">
    <table class="table table-hover mb-0" id="txTable">
      <thead class="table-light"><tr>
        <th>Date</th><th>Type</th><th>Product</th><th>Qty</th><th>Unit</th><th>Price</th><th>Amount</th><th>From</th><th>To</th><th>Reason</th><th class="no-print" style="width:40px"></th>
      </tr></thead>
      <tbody>
        {% for tx in transactions %}
        <tr>
          <td class="small">{{ tx.created_at.strftime('%Y-%m-%d %H:%M') if tx.created_at else '' }}</td>
          <td><span class="badge bg-{{ 'success' if tx.type=='in' else 'danger' if tx.type in ('out','discard','sale') else 'info' if tx.type=='move' else 'warning' }}">{{ tx.type|upper }}</span></td>
          <td>{{ tx.product_name }}</td>
          <td class="fw-bold">{{ tx.quantity|fmt_qty }}</td>
          <td>{{ tx.unit }}</td>
          <td class="text-end">{{ tx.unit_price|fmt_price }}</td>
          <td class="text-end">{{ tx.total_amount|fmt_price }}</td>
          <td>{{ tx.from_location or '-' }}</td>
          <td>{{ tx.to_location or '-' }}</td>
          <td class="small">{{ tx.reason or '' }}</td>
          <td class="no-print text-center">
            {% if attach_map.get(tx.id) %}
            <a href="#" onclick="showAttachments('transaction', {{ tx.id }}); return false;"
               title="View Receipt" class="text-primary"><i class="bi bi-paperclip"></i></a>
            {% endif %}
          </td>
        </tr>
        {% endfor %}
        {% if not transactions %}<tr><td colspan="11" class="text-center text-muted py-3">No transactions</td></tr>{% endif %}
      </tbody>
    </table>
  </div>
</div>
<div class="mt-2 no-print">
  <button class="btn btn-sm btn-outline-success" onclick="exportTableToCSV('txTable','transactions.csv')"><i class="bi bi-download me-1"></i>Export CSV</button>
</div>
<!-- Attachment Modal -->
<div class="modal fade" id="attachModal" tabindex="-1"><div class="modal-dialog modal-lg"><div class="modal-content">
  <div class="modal-header"><h5 class="modal-title"><i class="bi bi-paperclip me-2"></i>Attachments</h5>
    <button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
  <div class="modal-body" id="attachModalBody"><p class="text-muted">Loading...</p></div>
</div></div></div>
{% endblock %}
{% block scripts %}
<script>
function showAttachments(refType, refId) {
  var body = document.getElementById('attachModalBody');
  body.innerHTML = '<p class="text-muted">Loading...</p>';
  var modal = new bootstrap.Modal(document.getElementById('attachModal'));
  modal.show();
  fetch('/attachments/api/' + refType + '/' + refId)
    .then(function(r) { return r.json(); })
    .then(function(data) {
      if (!data.length) { body.innerHTML = '<p class="text-muted">No attachments</p>'; return; }
      var html = '<div class="row g-3">';
      data.forEach(function(att) {
        var isImage = att.file_type.startsWith('image/');
        html += '<div class="col-md-6">';
        html += '<div class="card border">';
        if (isImage) {
          html += '<img src="' + att.view_url + '" class="card-img-top" style="max-height:300px;object-fit:contain;background:#f8f9fa;">';
        } else {
          html += '<div class="card-img-top d-flex align-items-center justify-content-center bg-light" style="height:120px;">';
          html += '<i class="bi bi-file-earmark-pdf display-3 text-danger"></i></div>';
        }
        html += '<div class="card-body p-2">';
        html += '<small class="text-muted">' + att.file_name + ' (' + Math.round(att.file_size/1024) + ' KB)</small><br>';
        html += '<a href="' + att.view_url + '" target="_blank" class="btn btn-sm btn-outline-primary me-1 mt-1"><i class="bi bi-eye"></i> View</a>';
        html += '<a href="' + att.download_url + '" class="btn btn-sm btn-outline-success me-1 mt-1"><i class="bi bi-download"></i> Download</a>';
        html += '</div></div></div>';
      });
      html += '</div>';
      body.innerHTML = html;
    })
    .catch(function() { body.innerHTML = '<p class="text-danger">Failed to load</p>'; });
}
</script>
{% endblock %}
