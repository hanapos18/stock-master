{% extends "base.html" %}
{% block title %}Inventory - Hana StockMaster{% endblock %}
{% block page_title %}Inventory{% endblock %}
{% block content %}
<div class="d-flex flex-wrap justify-content-between mb-3 gap-2">
  <form class="d-flex gap-2" method="get">
    <input type="text" name="search" class="form-control form-control-sm" placeholder="Search..." value="{{ search }}" style="width:180px;">
    <select name="category_id" class="form-select form-select-sm" style="width:160px;" onchange="this.form.submit()">
      <option value="">All Categories</option>
      {% for c in categories %}<option value="{{ c.id }}" {{ 'selected' if selected_category == c.id }}>{{ c.name }}</option>{% endfor %}
    </select>
    <label class="form-check-label btn btn-sm {{ 'btn-warning' if low_stock else 'btn-outline-warning' }}">
      <input type="checkbox" name="low_stock" value="1" {{ 'checked' if low_stock }} class="form-check-input d-none" onchange="this.form.submit()"> Low Stock
    </label>
    <button class="btn btn-sm btn-outline-primary">Filter</button>
  </form>
  <div class="d-flex gap-2">
    <a href="{{ url_for('inventory.stock_in') }}" class="btn btn-success btn-sm"><i class="bi bi-plus-circle me-1"></i>Stock In</a>
    <a href="{{ url_for('inventory.stock_out') }}" class="btn btn-danger btn-sm"><i class="bi bi-dash-circle me-1"></i>Stock Out</a>
    <a href="{{ url_for('inventory.stock_move') }}" class="btn btn-info btn-sm"><i class="bi bi-arrow-left-right me-1"></i>Move</a>
    <a href="{{ url_for('inventory.all_stores_inventory') }}" class="btn btn-outline-primary btn-sm"><i class="bi bi-globe me-1"></i>All Stores</a>
    <a href="{{ url_for('inventory.transactions') }}" class="btn btn-outline-secondary btn-sm">History</a>
  </div>
</div>
<div class="card border-0 shadow-sm">
  <div class="table-responsive">
    <table class="table table-hover mb-0" id="invTable">
      <thead class="table-light"><tr>
        <th>Code</th><th>Product</th><th>Category</th><th>Location</th><th>Quantity</th><th>Unit</th><th>Expiry Date</th><th>Actions</th>
      </tr></thead>
      <tbody>
        {% for i in items %}
        {% set days_left = none %}
        {% if i.expiry_date %}
          {% set days_left = (i.expiry_date - today).days if today else none %}
        {% endif %}
        <tr class="{{ 'table-danger' if days_left is not none and days_left < 0 else 'table-warning' if days_left is not none and days_left <= 7 else 'table-danger' if i.quantity <= i.min_stock and i.min_stock > 0 and days_left is none else '' }}">
          <td><code>{{ i.product_code }}</code></td>
          <td>{{ i.product_name }}</td>
          <td>{{ i.category_name or '-' }}</td>
          <td><span class="badge bg-secondary">{{ locations.get(i.location, i.location) }}</span></td>
          <td class="fw-bold">{{ i.quantity|fmt_qty }}</td>
          <td>{{ i.unit }}</td>
          <td>
            {% if i.expiry_date %}
              {% if days_left < 0 %}
                <span class="badge bg-danger"><i class="bi bi-exclamation-triangle me-1"></i>Expired ({{ i.expiry_date.strftime('%Y-%m-%d') }})</span>
              {% elif days_left <= 7 %}
                <span class="badge bg-warning text-dark"><i class="bi bi-clock me-1"></i>{{ days_left }}d ({{ i.expiry_date.strftime('%Y-%m-%d') }})</span>
              {% elif days_left <= 30 %}
                <span class="badge bg-info text-dark">{{ days_left }}d ({{ i.expiry_date.strftime('%Y-%m-%d') }})</span>
              {% else %}
                <span class="text-success">{{ i.expiry_date.strftime('%Y-%m-%d') }}</span>
              {% endif %}
            {% else %}
              <span class="text-muted">-</span>
            {% endif %}
          </td>
          <td>
            <button class="btn btn-sm btn-outline-warning" data-bs-toggle="modal" data-bs-target="#adjustModal{{ i.id }}">Adjust</button>
            <button class="btn btn-sm btn-outline-danger" data-bs-toggle="modal" data-bs-target="#discardModal{{ i.id }}">Discard</button>
          </td>
        </tr>
        <!-- Adjust Modal -->
        <div class="modal fade" id="adjustModal{{ i.id }}" tabindex="-1"><div class="modal-dialog"><div class="modal-content">
          <form method="post" action="{{ url_for('inventory.stock_adjust') }}">
          <input type="hidden" name="inventory_id" value="{{ i.id }}">
          <input type="hidden" name="product_id" value="{{ i.product_id }}"><input type="hidden" name="location" value="{{ i.location }}">
          <div class="modal-header"><h5 class="modal-title">Adjust: {{ i.product_name }}</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
          <div class="modal-body">
            <p>Current: <strong>{{ i.quantity|fmt_qty }} {{ i.unit }}</strong></p>
            {% if i.expiry_date %}<p>Expiry: <span class="badge bg-secondary">{{ i.expiry_date.strftime('%Y-%m-%d') }}</span></p>{% endif %}
            <div class="mb-3"><label class="form-label">New Quantity</label><input type="number" name="new_quantity" class="form-control" step="0.01" value="{{ i.quantity }}" required></div>
            <div class="mb-3"><label class="form-label">Reason</label><input type="text" name="reason" class="form-control"></div>
          </div>
          <div class="modal-footer"><button type="submit" class="btn btn-warning">Adjust</button></div>
          </form></div></div></div>
        <!-- Discard Modal -->
        <div class="modal fade" id="discardModal{{ i.id }}" tabindex="-1"><div class="modal-dialog"><div class="modal-content">
          <form method="post" action="{{ url_for('inventory.stock_discard') }}">
          <input type="hidden" name="inventory_id" value="{{ i.id }}">
          <input type="hidden" name="product_id" value="{{ i.product_id }}"><input type="hidden" name="location" value="{{ i.location }}">
          <div class="modal-header"><h5 class="modal-title">Discard: {{ i.product_name }}</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
          <div class="modal-body">
            <p>Current: <strong>{{ i.quantity|fmt_qty }} {{ i.unit }}</strong></p>
            {% if i.expiry_date %}<p>Expiry: <span class="badge bg-{{ 'danger' if days_left is not none and days_left < 0 else 'warning' }}">{{ i.expiry_date.strftime('%Y-%m-%d') }}</span></p>{% endif %}
            <div class="mb-3"><label class="form-label">Discard Quantity</label><input type="number" name="quantity" class="form-control" step="0.01" min="0.01" max="{{ i.quantity }}" required></div>
            <div class="mb-3"><label class="form-label">Reason</label><input type="text" name="reason" class="form-control" placeholder="Expired, damaged, etc."></div>
          </div>
          <div class="modal-footer"><button type="submit" class="btn btn-danger">Discard</button></div>
          </form></div></div></div>
        {% endfor %}
        {% if not items %}<tr><td colspan="8" class="text-center text-muted py-3">No inventory items</td></tr>{% endif %}
      </tbody>
    </table>
  </div>
</div>
{% endblock %}
