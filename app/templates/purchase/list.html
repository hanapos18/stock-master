{% extends "base.html" %}
{% block title %}Purchases - Hana StockMaster{% endblock %}
{% block page_title %}Purchases{% endblock %}
{% block content %}
<div class="d-flex justify-content-between mb-3">
  <div class="d-flex gap-2">
    <a href="{{ url_for('purchase.list_purchases') }}" class="btn btn-sm {{ 'btn-primary' if not selected_status else 'btn-outline-primary' }}">All</a>
    {% for s in ['draft','confirmed','received','cancelled'] %}
    <a href="{{ url_for('purchase.list_purchases', status=s) }}" class="btn btn-sm {{ 'btn-primary' if selected_status==s else 'btn-outline-primary' }}">{{ s|capitalize }}</a>{% endfor %}
  </div>
  <div class="d-flex gap-2">
    <a href="{{ url_for('purchase.export_excel') }}" class="btn btn-outline-primary btn-sm"><i class="bi bi-file-earmark-arrow-down me-1"></i>Excel Export</a>
    <button class="btn btn-success btn-sm" data-bs-toggle="modal" data-bs-target="#excelUploadModal"><i class="bi bi-file-earmark-arrow-up me-1"></i>Excel Upload</button>
    <a href="{{ url_for('purchase.download_template') }}" class="btn btn-outline-success btn-sm"><i class="bi bi-download me-1"></i>Template</a>
    <a href="{{ url_for('purchase.create_purchase') }}" class="btn btn-primary btn-sm"><i class="bi bi-plus-circle me-1"></i>New Purchase</a>
  </div>
</div>
<div class="card border-0 shadow-sm"><div class="table-responsive">
  <table class="table table-hover mb-0"><thead class="table-light"><tr>
    <th>Number</th><th>Date</th><th>Supplier</th><th>Store</th><th>Amount</th><th>Status</th><th>Actions</th>
  </tr></thead><tbody>
    {% for p in purchases %}<tr>
      <td><a href="{{ url_for('purchase.view_purchase', purchase_id=p.id) }}">{{ p.purchase_number }}</a></td>
      <td>{{ p.purchase_date }}</td><td>{{ p.supplier_name or '-' }}</td><td>{{ p.store_name }}</td>
      <td class="text-end fw-bold">{{ p.total_amount|fmt_price }}</td>
      <td><span class="badge bg-{{ 'success' if p.status=='received' else 'warning' if p.status=='draft' else 'secondary' }}">{{ p.status }}</span></td>
      <td><a href="{{ url_for('purchase.view_purchase', purchase_id=p.id) }}" class="btn btn-sm btn-outline-primary">View</a></td>
    </tr>{% endfor %}
    {% if not purchases %}<tr><td colspan="7" class="text-center text-muted py-3">No purchases</td></tr>{% endif %}
  </tbody></table>
</div></div>
<!-- Excel Upload Modal -->
<div class="modal fade" id="excelUploadModal" tabindex="-1"><div class="modal-dialog"><div class="modal-content">
  <div class="modal-header">
    <h5 class="modal-title"><i class="bi bi-file-earmark-excel text-success me-2"></i>Excel Purchase Upload</h5>
    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
  </div>
  <form method="post" action="{{ url_for('purchase.upload_excel') }}" enctype="multipart/form-data">
    <div class="modal-body">
      <div class="mb-3">
        <label class="form-label fw-bold">Select Excel File (.xlsx)</label>
        <input type="file" class="form-control" name="excel_file" accept=".xlsx,.xls" required>
      </div>
      <div class="alert alert-info small mb-0">
        <i class="bi bi-info-circle me-1"></i>
        <ul class="mb-0 mt-1">
          <li>Download <a href="{{ url_for('purchase.download_template') }}">Template</a> first</li>
          <li>Same Date + Supplier + Memo = one purchase order</li>
          <li>Product Code must match existing products</li>
          <li>Purchases are created as <strong>Draft</strong> status</li>
        </ul>
      </div>
    </div>
    <div class="modal-footer">
      <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
      <button type="submit" class="btn btn-success"><i class="bi bi-upload me-1"></i>Upload</button>
    </div>
  </form>
</div></div></div>
{% endblock %}
