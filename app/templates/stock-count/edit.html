{% extends "base.html" %}
{% block title %}Edit Stock Count{% endblock %}
{% block page_title %}Stock Count - {{ count.count_date }} ({{ count.store_name }}){% endblock %}
{% block content %}
<div class="card border-0 shadow-sm">
  <div class="card-body">
    {% if count.category_name %}
    <p class="mb-2"><span class="badge bg-info">{{ count.category_name }}</span> — Enter actual quantities:</p>
    {% else %}
    <p class="mb-2"><span class="badge bg-primary">Full Count (All Products)</span> — {{ count.line_items|length }} items total</p>
    {% endif %}

    <!-- 빠른 이동 (카테고리가 여러 개일 때) -->
    {% if grouped|length > 1 %}
    <div class="mb-3">
      <small class="text-muted">Jump to category:</small>
      {% for cat_name in grouped.keys() %}
      <a href="#cat-{{ loop.index }}" class="badge bg-outline-secondary border me-1 text-decoration-none text-dark">{{ cat_name }} ({{ grouped[cat_name]|length }})</a>
      {% endfor %}
    </div>
    {% endif %}

    <form method="post">
      {% if grouped|length > 1 %}
      <!-- 카테고리별 그룹 (식당 전체 실사) -->
      {% for cat_name, items in grouped.items() %}
      <div id="cat-{{ loop.index }}" class="mb-4">
        <h6 class="bg-light p-2 rounded border-start border-primary border-3 sticky-top" style="top:0;z-index:10;">
          <i class="bi bi-tag me-1"></i>{{ cat_name }}
          <span class="badge bg-secondary ms-1">{{ items|length }}</span>
        </h6>
        <table class="table table-sm table-hover"><thead class="table-light"><tr>
          <th style="width:80px">Code</th><th>Product</th><th style="width:60px">Unit</th>
          <th style="width:90px">System</th><th style="width:110px">Actual</th>
          <th style="width:80px">Diff</th><th style="width:150px">Memo</th>
        </tr></thead><tbody>
          {% for i in items %}<tr>
            <td><code>{{ i.product_code }}</code></td>
            <td>{{ i.product_name }}</td>
            <td>{{ i.unit }}</td>
            <td class="text-end">{{ i.system_quantity|fmt_qty }}</td>
            <td>
              <input type="number" name="actual_{{ i.id }}" class="form-control form-control-sm"
                     step="0.01" value="{{ i.actual_quantity }}"
                     onchange="updateDiff(this, {{ i.system_quantity|float }})">
            </td>
            <td class="diff text-end {{ 'text-danger fw-bold' if (i.actual_quantity|float - i.system_quantity|float) != 0 }}">
              {{ (i.actual_quantity|float - i.system_quantity|float)|fmt_qty }}
            </td>
            <td><input type="text" name="memo_{{ i.id }}" class="form-control form-control-sm" value="{{ i.memo or '' }}" placeholder="..."></td>
          </tr>{% endfor %}
        </tbody></table>
      </div>
      {% endfor %}
      {% else %}
      <!-- 단일 카테고리 또는 소수 항목 -->
      <table class="table table-sm table-hover"><thead class="table-light"><tr>
        <th style="width:80px">Code</th><th>Product</th><th style="width:60px">Unit</th>
        <th style="width:90px">System</th><th style="width:110px">Actual</th>
        <th style="width:80px">Diff</th><th style="width:150px">Memo</th>
      </tr></thead><tbody>
        {% for i in count.line_items %}<tr>
          <td><code>{{ i.product_code }}</code></td>
          <td>{{ i.product_name }}</td>
          <td>{{ i.unit }}</td>
          <td class="text-end">{{ i.system_quantity|fmt_qty }}</td>
          <td>
            <input type="number" name="actual_{{ i.id }}" class="form-control form-control-sm"
                   step="0.01" value="{{ i.actual_quantity }}"
                   onchange="updateDiff(this, {{ i.system_quantity|float }})">
          </td>
          <td class="diff text-end {{ 'text-danger fw-bold' if (i.actual_quantity|float - i.system_quantity|float) != 0 }}">
            {{ (i.actual_quantity|float - i.system_quantity|float)|fmt_qty }}
          </td>
          <td><input type="text" name="memo_{{ i.id }}" class="form-control form-control-sm" value="{{ i.memo or '' }}" placeholder="..."></td>
        </tr>{% endfor %}
      </tbody></table>
      {% endif %}

      <div class="sticky-bottom bg-white py-2 border-top">
        <button type="submit" class="btn btn-primary"><i class="bi bi-check-circle me-1"></i>Save</button>
        <a href="{{ url_for('stock_count.view_count', count_id=count.id) }}" class="btn btn-outline-secondary ms-2">Cancel</a>
        <span class="text-muted ms-3 small">{{ count.line_items|length }} items</span>
      </div>
    </form>
  </div>
</div>

<script>
function updateDiff(el, systemQty) {
  const actual = parseFloat(el.value) || 0;
  const diff = actual - systemQty;
  const td = el.closest('tr').querySelector('.diff');
  td.textContent = diff.toFixed(2);
  if (diff !== 0) {
    td.classList.add('text-danger', 'fw-bold');
  } else {
    td.classList.remove('text-danger', 'fw-bold');
  }
}
</script>
{% endblock %}
