{% extends "base.html" %}
{% block title %}Stock Count Detail{% endblock %}
{% block page_title %}Stock Count - {{ count.count_date }}{% endblock %}
{% block content %}
<div class="card border-0 shadow-sm">
  <div class="card-body">
    <div class="row mb-3">
      <div class="col-md-3"><strong>Date:</strong> {{ count.count_date }}</div>
      <div class="col-md-3"><strong>Store:</strong> {{ count.store_name }}</div>
      <div class="col-md-3"><strong>Category:</strong>
        {% if count.category_name %}
        <span class="badge bg-info">{{ count.category_name }}</span>
        {% else %}
        <span class="badge bg-primary">All Products (Full Count)</span>
        {% endif %}
      </div>
      <div class="col-md-3"><strong>Status:</strong>
        <span class="badge bg-{{ 'success' if count.status=='approved' else 'warning' if count.status=='draft' else 'secondary' }}">{{ count.status }}</span>
      </div>
    </div>
    <!-- 요약 카드 -->
    {% set total_items = count.line_items|length %}
    {% set diff_items = count.line_items|selectattr('difference')|list %}
    {% set shortage = count.line_items|selectattr('difference', 'lt', 0)|list %}
    {% set surplus = count.line_items|selectattr('difference', 'gt', 0)|list %}
    <div class="row mb-3">
      <div class="col-md-3">
        <div class="card bg-light border-0"><div class="card-body py-2 text-center">
          <small class="text-muted">Total Items</small>
          <h5 class="mb-0">{{ total_items }}</h5>
        </div></div>
      </div>
      <div class="col-md-3">
        <div class="card bg-success bg-opacity-10 border-0"><div class="card-body py-2 text-center">
          <small class="text-muted">Match</small>
          <h5 class="text-success mb-0">{{ total_items - shortage|length - surplus|length }}</h5>
        </div></div>
      </div>
      <div class="col-md-3">
        <div class="card bg-danger bg-opacity-10 border-0"><div class="card-body py-2 text-center">
          <small class="text-muted">Shortage</small>
          <h5 class="text-danger mb-0">{{ shortage|length }}</h5>
        </div></div>
      </div>
      <div class="col-md-3">
        <div class="card bg-warning bg-opacity-10 border-0"><div class="card-body py-2 text-center">
          <small class="text-muted">Surplus</small>
          <h5 class="text-warning mb-0">{{ surplus|length }}</h5>
        </div></div>
      </div>
    </div>

    <!-- 상품 목록 (카테고리별 그룹) -->
    {% set current_cat = namespace(name='') %}
    <table class="table table-sm" id="countTable"><thead class="table-light"><tr>
      <th>Code</th><th>Product</th><th>Unit</th><th class="text-end">System</th><th class="text-end">Actual</th><th class="text-end">Diff</th><th>Memo</th>
    </tr></thead><tbody>
      {% for i in count.line_items %}
      {% set diff = i.actual_quantity|float - i.system_quantity|float %}
      {% if i.category_name != current_cat.name %}
        {% set current_cat.name = i.category_name %}
        <tr class="table-secondary"><td colspan="7"><strong><i class="bi bi-tag me-1"></i>{{ current_cat.name }}</strong></td></tr>
      {% endif %}
      <tr class="{{ 'table-danger' if diff < 0 else 'table-success' if diff > 0 else '' }}">
        <td><code>{{ i.product_code }}</code></td><td>{{ i.product_name }}</td><td>{{ i.unit }}</td>
        <td class="text-end">{{ i.system_quantity|fmt_qty }}</td>
        <td class="text-end fw-bold">{{ i.actual_quantity|fmt_qty }}</td>
        <td class="text-end fw-bold">{{ diff|fmt_qty }}</td>
        <td class="small">{{ i.memo or '' }}</td>
      </tr>{% endfor %}
    </tbody></table>

    <div class="mt-3">
      {% if count.status != 'approved' %}
      <form method="post" action="{{ url_for('stock_count.approve_count', count_id=count.id) }}" class="d-inline">
        <button class="btn btn-success" onclick="return confirm('Approve and adjust inventory?')"><i class="bi bi-check-circle me-1"></i>Approve (Adjust Inventory)</button>
      </form>
      <a href="{{ url_for('stock_count.edit_count', count_id=count.id) }}" class="btn btn-outline-primary ms-2">Edit</a>{% endif %}
      <button class="btn btn-outline-success ms-2" onclick="exportTableToCSV('countTable','stock_count_{{ count.count_date }}.csv')"><i class="bi bi-download me-1"></i>CSV</button>
      <a href="{{ url_for('stock_count.list_counts') }}" class="btn btn-outline-secondary ms-2">Back</a>
    </div>
  </div>
</div>
{% endblock %}
