{% extends "base.html" %}
{% block title %}Expiry Report - Hana StockMaster{% endblock %}
{% block page_title %}Expiry Date Report{% endblock %}
{% block content %}
<!-- Summary Cards -->
<div class="row g-3 mb-4">
  <div class="col-md-4">
    <div class="card border-0 shadow-sm border-start border-danger border-4">
      <div class="card-body text-center">
        <h3 class="text-danger mb-0">{{ alerts.expired_count }}</h3>
        <small class="text-muted">Expired</small>
      </div>
    </div>
  </div>
  <div class="col-md-4">
    <div class="card border-0 shadow-sm border-start border-warning border-4">
      <div class="card-body text-center">
        <h3 class="text-warning mb-0">{{ alerts.expiring_count }}</h3>
        <small class="text-muted">Expiring (30 days)</small>
      </div>
    </div>
  </div>
  <div class="col-md-4">
    <div class="card border-0 shadow-sm border-start border-info border-4">
      <div class="card-body text-center">
        <h3 class="text-info mb-0">{{ data|length }}</h3>
        <small class="text-muted">Showing</small>
      </div>
    </div>
  </div>
</div>

<!-- Filters -->
<div class="d-flex gap-2 mb-3">
  <a href="?filter=all" class="btn btn-sm {{ 'btn-primary' if filter_type == 'all' else 'btn-outline-primary' }}">All</a>
  <a href="?filter=expired" class="btn btn-sm {{ 'btn-danger' if filter_type == 'expired' else 'btn-outline-danger' }}">
    <i class="bi bi-exclamation-triangle me-1"></i>Expired</a>
  <a href="?filter=week" class="btn btn-sm {{ 'btn-warning' if filter_type == 'week' else 'btn-outline-warning' }}">
    <i class="bi bi-clock me-1"></i>Within 7 Days</a>
  <a href="?filter=month" class="btn btn-sm {{ 'btn-info' if filter_type == 'month' else 'btn-outline-info' }}">
    <i class="bi bi-calendar me-1"></i>Within 30 Days</a>
</div>

<!-- Table -->
<div class="card border-0 shadow-sm">
  <div class="table-responsive">
    <table class="table table-hover mb-0">
      <thead class="table-light"><tr>
        <th>Code</th><th>Product</th><th>Category</th><th>Store</th><th>Qty</th><th>Expiry Date</th><th>Days Left</th><th>Status</th>
      </tr></thead>
      <tbody>
        {% for r in data %}
        {% set dl = r.days_left %}
        <tr class="{{ 'table-danger' if dl < 0 else 'table-warning' if dl <= 7 else '' }}">
          <td><code>{{ r.product_code }}</code></td>
          <td>{{ r.product_name }}</td>
          <td>{{ r.category_name or '-' }}</td>
          <td>{{ r.store_name }}</td>
          <td class="fw-bold">{{ r.quantity|fmt_qty }} {{ r.unit }}</td>
          <td>{{ r.expiry_date.strftime('%Y-%m-%d') if r.expiry_date }}</td>
          <td>
            {% if dl < 0 %}
              <span class="fw-bold text-danger">{{ dl }} days</span>
            {% elif dl == 0 %}
              <span class="fw-bold text-danger">Today!</span>
            {% else %}
              <span class="{{ 'text-warning fw-bold' if dl <= 7 else 'text-info' if dl <= 30 else '' }}">{{ dl }} days</span>
            {% endif %}
          </td>
          <td>
            {% if dl < 0 %}
              <span class="badge bg-danger">Expired</span>
            {% elif dl <= 7 %}
              <span class="badge bg-warning text-dark">Urgent</span>
            {% elif dl <= 30 %}
              <span class="badge bg-info text-dark">Caution</span>
            {% else %}
              <span class="badge bg-success">OK</span>
            {% endif %}
          </td>
        </tr>
        {% endfor %}
        {% if not data %}
        <tr><td colspan="8" class="text-center text-muted py-4">
          {% if filter_type == 'expired' %}No expired items found
          {% elif filter_type == 'week' %}No items expiring within 7 days
          {% elif filter_type == 'month' %}No items expiring within 30 days
          {% else %}No items with expiry dates{% endif %}
        </td></tr>
        {% endif %}
      </tbody>
    </table>
  </div>
</div>
{% endblock %}
