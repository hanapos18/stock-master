{% extends "base.html" %}
{% block title %}New Transfer - Hana StockMaster{% endblock %}
{% block page_title %}New Inter-Store Transfer{% endblock %}
{% block content %}
<style>
.lot-row { background: #f8f9fa; border: 1px solid #e9ecef; border-radius: 6px; padding: 10px 14px; margin-bottom: 6px; }
.lot-row.lot-expired { border-left: 4px solid #dc3545; }
.lot-row.lot-warning { border-left: 4px solid #ffc107; }
.lot-row.lot-ok { border-left: 4px solid #28a745; }
.lot-row.lot-none { border-left: 4px solid #6c757d; }
.product-item { border: 1px solid #dee2e6; border-radius: 8px; padding: 16px; margin-bottom: 16px; background: #fff; }
</style>

<div class="card border-0 shadow-sm" style="max-width:800px;">
  <div class="card-body">
    <form method="post" action="{{ url_for('transfer.create_transfer') }}" id="transferForm">
      <div class="row mb-3">
        <div class="col-md-5">
          <label class="form-label">From Store *</label>
          <select name="from_store_id" id="fromStore" class="form-select" required onchange="onFromStoreChange()">
            {% for s in stores %}
            <option value="{{ s.id }}" {{ 'selected' if s.id == current_store_id }}>
              {{ s.name }}{{ ' (Warehouse)' if s.is_warehouse else '' }}
            </option>
            {% endfor %}
          </select>
        </div>
        <div class="col-md-2 d-flex align-items-end justify-content-center pb-2">
          <i class="bi bi-arrow-right fs-4 text-muted"></i>
        </div>
        <div class="col-md-5">
          <label class="form-label">To Store *</label>
          <select name="to_store_id" id="toStore" class="form-select" required>
            {% for s in stores %}
            <option value="{{ s.id }}" {{ 'disabled' if s.id == current_store_id }}>
              {{ s.name }}{{ ' (Warehouse)' if s.is_warehouse else '' }}
            </option>
            {% endfor %}
          </select>
        </div>
      </div>

      <div class="mb-3">
        <label class="form-label">Memo</label>
        <input type="text" name="memo" class="form-control" placeholder="Optional memo...">
      </div>

      <hr>

      <!-- 상품 추가 -->
      <div class="mb-3 position-relative">
        <label class="form-label"><strong>Add Products</strong></label>
        <input type="text" id="productSearch" class="form-control" placeholder="Search product..." autocomplete="off">
        <div id="searchResults" class="product-search-results" style="display:none;"></div>
      </div>

      <!-- 선택된 상품 목록 -->
      <div id="productList"></div>

      <div class="mt-2 p-2 bg-light rounded d-flex justify-content-between">
        <span>Total Items:</span>
        <strong id="totalItems">0 items, 0 qty</strong>
      </div>

      <div class="mt-3">
        <button type="submit" class="btn btn-primary" id="submitBtn" disabled>
          <i class="bi bi-send me-1"></i>Create Transfer</button>
        <a href="{{ url_for('transfer.list_transfers') }}" class="btn btn-outline-secondary ms-2">Cancel</a>
      </div>
    </form>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
var addedProducts = {};

initProductSearch('productSearch', 'searchResults', function(p) {
  if (addedProducts[p.id]) {
    alert('Product already added');
    return;
  }
  addProduct(p);
});

function onFromStoreChange() {
  var fromId = document.getElementById('fromStore').value;
  var toSelect = document.getElementById('toStore');
  for (var i = 0; i < toSelect.options.length; i++) {
    toSelect.options[i].disabled = (toSelect.options[i].value === fromId);
  }
  if (toSelect.value === fromId) {
    toSelect.value = '';
  }
  document.getElementById('productList').innerHTML = '';
  addedProducts = {};
  updateTotal();
}

function addProduct(p) {
  addedProducts[p.id] = true;
  var fromStoreId = document.getElementById('fromStore').value;
  var container = document.getElementById('productList');
  var div = document.createElement('div');
  div.className = 'product-item';
  div.id = 'product-' + p.id;
  div.innerHTML =
    '<div class="d-flex justify-content-between align-items-center mb-2">' +
      '<div><code>' + p.code + '</code> <strong>' + p.name + '</strong> <small class="text-muted">(' + p.unit + ')</small></div>' +
      '<button type="button" class="btn btn-sm btn-outline-danger" onclick="removeProduct(' + p.id + ')">' +
        '<i class="bi bi-x-lg"></i></button>' +
    '</div>' +
    '<div class="lot-container" id="lots-' + p.id + '">' +
      '<div class="text-center text-muted py-2"><span class="spinner-border spinner-border-sm"></span> Loading lots...</div>' +
    '</div>';
  container.appendChild(div);
  loadProductLots(fromStoreId, p.id);
}

function removeProduct(productId) {
  var el = document.getElementById('product-' + productId);
  if (el) el.remove();
  delete addedProducts[productId];
  updateTotal();
}

function loadProductLots(storeId, productId) {
  fetch('/transfer/api/lots/' + storeId + '/' + productId)
    .then(function(r) { return r.json(); })
    .then(function(lots) {
      var container = document.getElementById('lots-' + productId);
      container.innerHTML = '';
      if (lots.length === 0) {
        container.innerHTML = '<div class="text-muted text-center py-2">No stock available in this store</div>';
        return;
      }
      lots.forEach(function(lot) {
        var statusClass = 'lot-none';
        var expiryLabel = '<span class="text-muted">No expiry</span>';
        if (lot.expiry_date) {
          if (lot.days_left < 0) {
            statusClass = 'lot-expired';
            expiryLabel = '<span class="badge bg-danger">Expired (' + lot.expiry_date + ')</span>';
          } else if (lot.days_left <= 7) {
            statusClass = 'lot-warning';
            expiryLabel = '<span class="badge bg-warning text-dark">' + lot.days_left + 'd (' + lot.expiry_date + ')</span>';
          } else {
            statusClass = 'lot-ok';
            expiryLabel = '<span class="text-success">' + lot.expiry_date + ' (' + lot.days_left + 'd)</span>';
          }
        }
        var row = document.createElement('div');
        row.className = 'lot-row ' + statusClass;
        row.innerHTML =
          '<div class="d-flex justify-content-between align-items-center">' +
            '<div>' +
              '<span class="me-3">Loc: <strong>' + lot.location + '</strong></span>' +
              expiryLabel +
              '<span class="ms-3">Available: <strong>' + lot.quantity + '</strong></span>' +
            '</div>' +
            '<div style="width:130px;">' +
              '<input type="hidden" name="lot_id[]" value="' + lot.id + '">' +
              '<input type="number" name="lot_qty[]" class="form-control form-control-sm lot-qty-input" ' +
                'value="0" min="0" max="' + lot.quantity + '" step="0.01" ' +
                'onchange="updateTotal()" oninput="updateTotal()">' +
            '</div>' +
          '</div>';
        container.appendChild(row);
      });
    });
}

function updateTotal() {
  var inputs = document.querySelectorAll('.lot-qty-input');
  var totalQty = 0;
  var totalItems = 0;
  inputs.forEach(function(input) {
    var v = parseFloat(input.value) || 0;
    if (v > 0) {
      totalQty += v;
      totalItems++;
    }
  });
  document.getElementById('totalItems').textContent = totalItems + ' lots, ' + totalQty.toFixed(2) + ' qty';
  document.getElementById('submitBtn').disabled = totalQty <= 0;
}
</script>
{% endblock %}
