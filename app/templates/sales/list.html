{% extends "base.html" %}
{% block title %}Sales - Hana StockMaster{% endblock %}
{% block page_title %}Sales{% endblock %}
{% block content %}
<!-- 날짜 필터 -->
<div class="card border-0 shadow-sm mb-3">
  <div class="card-body py-2">
    <form method="get" class="row g-2 align-items-end">
      <div class="col-auto">
        <label class="form-label small mb-0">From</label>
        <input type="date" name="date_from" class="form-control form-control-sm" value="{{ date_from }}">
      </div>
      <div class="col-auto">
        <label class="form-label small mb-0">To</label>
        <input type="date" name="date_to" class="form-control form-control-sm" value="{{ date_to }}">
      </div>
      {% if selected_status %}<input type="hidden" name="status" value="{{ selected_status }}">{% endif %}
      <div class="col-auto">
        <button type="submit" class="btn btn-sm btn-primary"><i class="bi bi-search me-1"></i>Search</button>
      </div>
      <div class="col-auto">
        <a href="{{ url_for('sales.list_sales', date_from=today, date_to=today) }}" class="btn btn-sm btn-outline-info">Today</a>
      </div>
      <div class="col-auto">
        <a href="{{ url_for('sales.list_sales', date_from=week_ago, date_to=today) }}" class="btn btn-sm btn-outline-info">This Week</a>
      </div>
      <div class="col-auto">
        <a href="{{ url_for('sales.list_sales', date_from=month_start, date_to=today) }}" class="btn btn-sm btn-outline-info">This Month</a>
      </div>
      <div class="col-auto">
        <a href="{{ url_for('sales.list_sales') }}" class="btn btn-sm btn-outline-secondary">All</a>
      </div>
    </form>
  </div>
</div>

<!-- 정산 요약 카드 -->
{% if summary %}
<div class="row mb-3">
  <div class="col-md-3">
    <div class="card border-0 shadow-sm bg-primary bg-opacity-10">
      <div class="card-body py-2 text-center">
        <small class="text-muted">Total Sales</small>
        <h5 class="fw-bold mb-0">{{ summary.total_count or 0 }}</h5>
      </div>
    </div>
  </div>
  <div class="col-md-3">
    <div class="card border-0 shadow-sm bg-success bg-opacity-10">
      <div class="card-body py-2 text-center">
        <small class="text-muted">Confirmed</small>
        <h5 class="fw-bold text-success mb-0">{{ summary.confirmed_amount|fmt_price }} <small class="text-muted">({{ summary.confirmed_count or 0 }})</small></h5>
      </div>
    </div>
  </div>
  <div class="col-md-3">
    <div class="card border-0 shadow-sm bg-warning bg-opacity-10">
      <div class="card-body py-2 text-center">
        <small class="text-muted">Draft</small>
        <h5 class="fw-bold text-warning mb-0">{{ summary.draft_amount|fmt_price }} <small class="text-muted">({{ summary.draft_count or 0 }})</small></h5>
      </div>
    </div>
  </div>
  <div class="col-md-3">
    <div class="card border-0 shadow-sm">
      <div class="card-body py-2 text-center">
        <small class="text-muted">Total Amount</small>
        <h5 class="fw-bold text-primary mb-0">{{ summary.total_amount|fmt_price }}</h5>
      </div>
    </div>
  </div>
</div>
{% endif %}

<!-- 상태 필터 + 액션 -->
<div class="d-flex justify-content-between mb-3">
  <div class="d-flex gap-2">
    <a href="{{ url_for('sales.list_sales', date_from=date_from, date_to=date_to) }}" class="btn btn-sm {{ 'btn-primary' if not selected_status else 'btn-outline-primary' }}">All</a>
    {% for s in ['draft','confirmed','cancelled'] %}
    <a href="{{ url_for('sales.list_sales', status=s, date_from=date_from, date_to=date_to) }}" class="btn btn-sm {{ 'btn-primary' if selected_status==s else 'btn-outline-primary' }}">{{ s|capitalize }}</a>{% endfor %}
  </div>
  <div class="d-flex gap-2">
    <a href="{{ url_for('sales.settlement') }}" class="btn btn-outline-dark btn-sm"><i class="bi bi-calculator me-1"></i>Settlement</a>
    <a href="{{ url_for('sales.upload_sales_excel') }}" class="btn btn-success btn-sm"><i class="bi bi-file-earmark-excel me-1"></i>Excel Upload</a>
    <a href="{{ url_for('sales.create_sale') }}" class="btn btn-primary btn-sm"><i class="bi bi-plus-circle me-1"></i>New Sale</a>
  </div>
</div>

<!-- 판매 목록 -->
<div class="card border-0 shadow-sm"><div class="table-responsive">
  <table class="table table-hover mb-0"><thead class="table-light"><tr>
    <th>Number</th><th>Date</th><th>Customer</th><th>Store</th><th>Amount</th><th>Status</th><th>Actions</th>
  </tr></thead><tbody>
    {% for sa in sales %}<tr>
      <td><a href="{{ url_for('sales.view_sale', sale_id=sa.id) }}">{{ sa.sale_number }}</a></td>
      <td>{{ sa.sale_date }}</td><td>{{ sa.customer_name or '-' }}</td><td>{{ sa.store_name }}</td>
      <td class="text-end fw-bold">{{ sa.total_amount|fmt_price }}</td>
      <td><span class="badge bg-{{ 'success' if sa.status=='confirmed' else 'warning' if sa.status=='draft' else 'secondary' }}">{{ sa.status }}</span></td>
      <td><a href="{{ url_for('sales.view_sale', sale_id=sa.id) }}" class="btn btn-sm btn-outline-primary">View</a></td>
    </tr>{% endfor %}
    {% if not sales %}<tr><td colspan="7" class="text-center text-muted py-3">No sales found</td></tr>{% endif %}
  </tbody></table>
</div></div>
{% endblock %}
