{% extends "base.html" %}
{% block title %}Sale {{ sale.sale_number }}{% endblock %}
{% block page_title %}Sale {{ sale.sale_number }}{% endblock %}
{% block content %}
<div class="card border-0 shadow-sm">
  <div class="card-body">
    <div class="row mb-3">
      <div class="col-md-3"><strong>Date:</strong> {{ sale.sale_date }}</div>
      <div class="col-md-3"><strong>Customer:</strong> {{ sale.customer_name or 'N/A' }}</div>
      <div class="col-md-3"><strong>Store:</strong> {{ sale.store_name }}</div>
      <div class="col-md-3"><strong>Status:</strong> <span class="badge bg-{{ 'success' if sale.status=='confirmed' else 'warning' }}">{{ sale.status }}</span></div>
    </div>
    <table class="table table-sm"><thead class="table-light"><tr><th>Code</th><th>Product</th><th>Qty</th><th>Unit</th><th>Price</th><th>Amount</th></tr></thead><tbody>
      {% for i in sale.line_items %}<tr>
        <td><code>{{ i.product_code }}</code></td><td>{{ i.product_name }}</td><td>{{ i.quantity|fmt_qty }}</td><td>{{ i.unit }}</td>
        <td class="text-end">{{ i.unit_price|fmt_price }}</td><td class="text-end">{{ i.amount|fmt_price }}</td>
      </tr>{% endfor %}
      <tr class="fw-bold"><td colspan="5" class="text-end">Total:</td><td class="text-end">{{ sale.total_amount|fmt_price }}</td></tr>
    </tbody></table>
    <div class="mt-3">
      {% if sale.status == 'draft' %}
      <a href="{{ url_for('sales.confirm_sale', sale_id=sale.id) }}" class="btn btn-success"><i class="bi bi-check-circle me-1"></i>Confirm (Select Lots)</a>
      <form method="post" action="{{ url_for('sales.cancel_sale', sale_id=sale.id) }}" class="d-inline ms-2">
        <button class="btn btn-outline-danger">Cancel</button>
      </form>{% endif %}
      <a href="{{ url_for('sales.print_delivery', sale_id=sale.id) }}" class="btn btn-outline-primary" target="_blank"><i class="bi bi-printer me-1"></i>Print Delivery List</a>
      <a href="{{ url_for('sales.preview_receipt', sale_id=sale.id) }}" class="btn btn-outline-success"><i class="bi bi-receipt me-1"></i>Receipt Print</a>
      <button class="btn btn-success" id="btnDirectPrint" onclick="sendReceipt()"><i class="bi bi-printer-fill me-1"></i>Quick Receipt</button>
      <a href="{{ url_for('sales.list_sales') }}" class="btn btn-outline-secondary ms-2">Back</a>
    </div>
  </div>
</div>
{% endblock %}
{% block scripts %}
<script>
function sendReceipt() {
  const btn = document.getElementById('btnDirectPrint');
  btn.disabled = true;
  btn.innerHTML = '<i class="bi bi-hourglass-split me-1"></i>Printing...';
  fetch('{{ url_for("sales.print_receipt", sale_id=sale.id) }}', { method: 'POST' })
    .then(r => r.json())
    .then(data => {
      btn.disabled = false;
      btn.innerHTML = '<i class="bi bi-printer-fill me-1"></i>Quick Receipt';
      if (data.success) {
        alert('Receipt sent to printer!');
      } else {
        alert('Print failed: ' + data.message);
      }
    })
    .catch(err => {
      btn.disabled = false;
      btn.innerHTML = '<i class="bi bi-printer-fill me-1"></i>Quick Receipt';
      alert('Error: ' + err.message);
    });
}
</script>
{% endblock %}
