{% extends "base.html" %}
{% block title %}{{ 'Edit' if client else 'New' }} Wholesale Client{% endblock %}
{% block page_title %}{{ 'Edit' if client else 'New' }} Wholesale Client{% endblock %}
{% block content %}
<div class="row g-4">
  <div class="col-lg-6">
    <div class="card border-0 shadow-sm">
      <div class="card-header bg-white"><h6 class="mb-0">Client Info</h6></div>
      <div class="card-body">
        <form method="post">
          <div class="row g-3">
            <div class="col-md-8"><label class="form-label">Name *</label><input type="text" name="name" class="form-control" required value="{{ client.name if client else '' }}"></div>
            <div class="col-md-4"><label class="form-label">Default Disc %</label><input type="number" name="default_discount_rate" class="form-control" step="0.01" value="{{ client.default_discount_rate if client else '0' }}"></div>
            <div class="col-md-6"><label class="form-label">Contact</label><input type="text" name="contact_person" class="form-control" value="{{ client.contact_person if client else '' }}"></div>
            <div class="col-md-6"><label class="form-label">Phone</label><input type="text" name="phone" class="form-control" value="{{ client.phone if client else '' }}"></div>
            <div class="col-md-6"><label class="form-label">Email</label><input type="email" name="email" class="form-control" value="{{ client.email if client else '' }}"></div>
            <div class="col-md-6"><label class="form-label">Address</label><input type="text" name="address" class="form-control" value="{{ client.address if client else '' }}"></div>
            <div class="col-12"><label class="form-label">Memo</label><textarea name="memo" class="form-control" rows="2">{{ client.memo if client else '' }}</textarea></div>
          </div>
          <div class="mt-3"><button type="submit" class="btn btn-primary">Save</button>
            <a href="{{ url_for('wholesale.list_clients') }}" class="btn btn-outline-secondary ms-2">Cancel</a></div>
        </form>
      </div>
    </div>
  </div>
  {% if client and client.pricing is defined %}
  <div class="col-lg-6">
    <div class="card border-0 shadow-sm">
      <div class="card-header bg-white"><h6 class="mb-0">Product Pricing</h6></div>
      <div class="card-body">
        <table class="table table-sm"><thead><tr><th>Product</th><th>Type</th><th>Rate/Price</th></tr></thead><tbody>
          {% for p in client.pricing %}<tr>
            <td>{{ p.product_name }}</td>
            <td>{{ p.discount_type }}</td>
            <td>{% if p.discount_type=='rate' %}{{ p.discount_rate|fmt_qty }}%{% else %}{{ p.fixed_price|fmt_price }}{% endif %}</td>
          </tr>{% endfor %}
          {% if not client.pricing %}<tr><td colspan="3" class="text-muted">No custom pricing</td></tr>{% endif %}
        </tbody></table>
        <hr>
        <form method="post" action="{{ url_for('wholesale.set_pricing', client_id=client.id) }}">
          <div class="row g-2">
            <div class="col-12 position-relative">
              <input type="text" id="productSearch" class="form-control form-control-sm" placeholder="Search product..." autocomplete="off">
              <div id="searchResults" class="product-search-results" style="display:none;"></div>
              <input type="hidden" name="product_id" id="selectedProductId" required>
              <div id="selectedProduct" class="mt-1 small text-success"></div>
            </div>
            <div class="col-6"><select name="discount_type" class="form-select form-select-sm"><option value="rate">Discount %</option><option value="fixed_price">Fixed Price</option></select></div>
            <div class="col-3"><input type="number" name="discount_rate" class="form-control form-control-sm" step="0.01" placeholder="%" value="0"></div>
            <div class="col-3"><input type="number" name="fixed_price" class="form-control form-control-sm" step="0.000001" placeholder="Price"></div>
            <div class="col-12"><button type="submit" class="btn btn-sm btn-primary w-100">Set Pricing</button></div>
          </div>
        </form>
      </div>
    </div>
  </div>
  {% endif %}
</div>
{% endblock %}
{% block scripts %}
<script>
initProductSearch('productSearch', 'searchResults', function(p) {
  document.getElementById('selectedProductId').value = p.id;
  document.getElementById('selectedProduct').textContent = p.code + ' - ' + p.name;
});
</script>
{% endblock %}
