{% extends "base.html" %}
{% block title %}Statement - {{ client.name }}{% endblock %}
{% block page_title %}Client Statement: {{ client.name }}{% endblock %}
{% block content %}
<!-- 거래처 정보 & 잔고 요약 -->
<div class="row mb-4">
  <div class="col-md-6">
    <div class="card border-0 shadow-sm">
      <div class="card-body">
        <h6><i class="bi bi-person-badge me-2"></i>Client Information</h6>
        <table class="table table-sm mb-0">
          <tr><td class="text-muted" style="width:120px">Name</td><td><strong>{{ client.name }}</strong></td></tr>
          <tr><td class="text-muted">Contact</td><td>{{ client.contact_person or '-' }}</td></tr>
          <tr><td class="text-muted">Phone</td><td>{{ client.phone or '-' }}</td></tr>
          <tr><td class="text-muted">Address</td><td>{{ client.address or '-' }}</td></tr>
        </table>
      </div>
    </div>
  </div>
  <div class="col-md-6">
    <div class="card border-0 shadow-sm bg-light">
      <div class="card-body">
        <h6><i class="bi bi-wallet2 me-2"></i>Balance Summary</h6>
        <div class="d-flex justify-content-between mb-1"><span>Total Ordered:</span><strong>{{ balance_info.total_order|fmt_price }}</strong></div>
        <div class="d-flex justify-content-between mb-1"><span>Total Paid:</span><strong class="text-success">{{ balance_info.total_paid|fmt_price }}</strong></div>
        <hr class="my-1">
        <div class="d-flex justify-content-between"><span>Outstanding Balance:</span><strong class="text-danger fs-5">{{ balance_info.balance|fmt_price }}</strong></div>
      </div>
    </div>
  </div>
</div>

<!-- 주문 목록 (잔금 포함) -->
<div class="card border-0 shadow-sm mb-4">
  <div class="card-header bg-white d-flex justify-content-between align-items-center">
    <h6 class="mb-0"><i class="bi bi-receipt me-2"></i>Orders</h6>
    <button onclick="window.print()" class="btn btn-sm btn-outline-secondary"><i class="bi bi-printer me-1"></i>Print</button>
  </div>
  <div class="table-responsive">
    <table class="table table-hover mb-0"><thead class="table-light"><tr>
      <th>Order #</th><th>Date</th><th>Status</th><th class="text-end">Final Amount</th><th class="text-end">Paid</th><th class="text-end">Balance</th><th>Payment</th>
    </tr></thead><tbody>
      {% for o in orders %}<tr>
        <td><a href="{{ url_for('wholesale.view_order', order_id=o.id) }}">{{ o.order_number }}</a></td>
        <td>{{ o.order_date }}</td>
        <td><span class="badge bg-{{ 'success' if o.status=='delivered' else 'info' if o.status=='shipped' else 'warning' }}">{{ o.status }}</span></td>
        <td class="text-end">{{ o.final_amount|fmt_price }}</td>
        <td class="text-end text-success">{{ o.paid_amount|fmt_price }}</td>
        <td class="text-end {{ 'text-danger fw-bold' if o.balance|float > 0 else '' }}">{{ o.balance|fmt_price }}</td>
        <td>
          {% if o.payment_status == 'paid' %}<span class="badge bg-success">Paid</span>
          {% elif o.payment_status == 'partial' %}<span class="badge bg-warning text-dark">Partial</span>
          {% else %}<span class="badge bg-danger">Unpaid</span>{% endif %}
        </td>
      </tr>{% endfor %}
      {% if not orders %}<tr><td colspan="7" class="text-center text-muted py-3">No orders</td></tr>{% endif %}
    </tbody></table>
  </div>
</div>

<!-- 결제 내역 -->
<div class="card border-0 shadow-sm mb-4">
  <div class="card-header bg-white"><h6 class="mb-0"><i class="bi bi-credit-card me-2"></i>Payment History</h6></div>
  <div class="table-responsive">
    <table class="table table-sm mb-0"><thead class="table-light"><tr>
      <th>Date</th><th>Order #</th><th>Method</th><th class="text-end">Amount</th><th>Check/Bank Info</th><th>Memo</th><th>By</th>
    </tr></thead><tbody>
      {% for p in payments %}<tr>
        <td>{{ p.paid_at }}</td>
        <td>{{ p.order_number }}</td>
        <td>
          {% if p.payment_method == 'cash' %}<span class="badge bg-success">Cash</span>
          {% elif p.payment_method == 'check' %}<span class="badge bg-info">Check</span>
          {% elif p.payment_method == 'bank_transfer' %}<span class="badge bg-primary">Bank Transfer</span>
          {% else %}<span class="badge bg-secondary">{{ p.payment_method }}</span>{% endif %}
        </td>
        <td class="text-end">{{ p.amount|fmt_price }}</td>
        <td>
          {% if p.payment_method == 'check' %}#{{ p.check_number or '-' }} ({{ p.check_date or '-' }})
          {% elif p.payment_method == 'bank_transfer' %}{{ p.bank_name or '' }} {{ p.bank_ref or '' }}
          {% else %}-{% endif %}
        </td>
        <td>{{ p.memo or '' }}</td>
        <td>{{ p.paid_by_name or '' }}</td>
      </tr>{% endfor %}
      {% if not payments %}<tr><td colspan="7" class="text-center text-muted py-3">No payments recorded</td></tr>{% endif %}
    </tbody></table>
  </div>
</div>

<a href="{{ url_for('wholesale.balances') }}" class="btn btn-outline-secondary"><i class="bi bi-arrow-left me-1"></i>Back to Balances</a>
<a href="{{ url_for('wholesale.edit_client', client_id=client.id) }}" class="btn btn-outline-primary ms-2"><i class="bi bi-pencil me-1"></i>Edit Client</a>
{% endblock %}
