{% extends "base.html" %}
{% block title %}User Management - Hana StockMaster{% endblock %}
{% block page_title %}User Management{% endblock %}
{% block content %}

<!-- 새 사용자 추가 -->
<div class="card border-0 shadow-sm mb-3">
  <div class="card-header bg-primary text-white">
    <i class="bi bi-person-plus me-2"></i>Create New User
  </div>
  <div class="card-body">
    <form method="post" action="{{ url_for('users.create_user') }}" class="row g-2 align-items-end">
      <div class="col-md-2">
        <label class="form-label small mb-0">Username</label>
        <input type="text" name="username" class="form-control form-control-sm" required>
      </div>
      <div class="col-md-2">
        <label class="form-label small mb-0">Name</label>
        <input type="text" name="name" class="form-control form-control-sm" required>
      </div>
      <div class="col-md-2">
        <label class="form-label small mb-0">Password</label>
        <input type="password" name="password" class="form-control form-control-sm" required>
      </div>
      <div class="col-md-2">
        <label class="form-label small mb-0">Role</label>
        <select name="role" class="form-select form-select-sm">
          <option value="staff">Staff</option>
          <option value="manager">Manager</option>
          <option value="admin">Admin</option>
        </select>
      </div>
      <div class="col-md-2">
        <label class="form-label small mb-0">Assigned Store</label>
        <select name="store_id" class="form-select form-select-sm">
          <option value="">HQ (All Stores)</option>
          {% for s in stores %}
          <option value="{{ s.id }}">{{ s.name }}{% if s.is_warehouse %} (Warehouse){% endif %}</option>
          {% endfor %}
        </select>
      </div>
      <div class="col-md-2">
        <button type="submit" class="btn btn-primary btn-sm w-100"><i class="bi bi-plus-circle me-1"></i>Create</button>
      </div>
    </form>
  </div>
</div>

<!-- 사용자 목록 -->
<div class="card border-0 shadow-sm">
  <div class="table-responsive">
    <table class="table table-hover mb-0">
      <thead class="table-light">
        <tr>
          <th>ID</th>
          <th>Username</th>
          <th>Name</th>
          <th>Role</th>
          <th>Assigned Store</th>
          <th>Access Scope</th>
          <th>Status</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
        {% for u in users %}
        <tr class="{{ 'table-secondary' if not u.is_active }}">
          <td>{{ u.id }}</td>
          <td><strong>{{ u.username }}</strong></td>
          <td>{{ u.name }}</td>
          <td>
            {% if u.role == 'admin' %}<span class="badge bg-danger">Admin</span>
            {% elif u.role == 'manager' %}<span class="badge bg-warning text-dark">Manager</span>
            {% else %}<span class="badge bg-secondary">Staff</span>{% endif %}
          </td>
          <td>{{ u.store_name or '-' }}</td>
          <td>
            {% if u.role == 'admin' or not u.store_id %}
            <span class="badge bg-primary">All Stores (HQ)</span>
            {% else %}
            <span class="badge bg-info text-dark">{{ u.store_name }} only</span>
            {% endif %}
          </td>
          <td>
            {% if u.is_active %}<span class="badge bg-success">Active</span>
            {% else %}<span class="badge bg-secondary">Inactive</span>{% endif %}
          </td>
          <td>
            <button class="btn btn-sm btn-outline-primary" data-bs-toggle="modal" data-bs-target="#editModal{{ u.id }}">
              <i class="bi bi-pencil"></i> Edit
            </button>
            {% if u.id != session.get('user', {}).get('id') %}
            <form method="post" action="{{ url_for('users.toggle_user', user_id=u.id) }}" class="d-inline">
              <button type="submit" class="btn btn-sm btn-outline-{{ 'danger' if u.is_active else 'success' }}">
                {{ 'Deactivate' if u.is_active else 'Activate' }}
              </button>
            </form>
            {% endif %}
          </td>
        </tr>

        <!-- 수정 모달 -->
        <div class="modal fade" id="editModal{{ u.id }}" tabindex="-1">
          <div class="modal-dialog">
            <div class="modal-content">
              <form method="post" action="{{ url_for('users.update_user', user_id=u.id) }}">
                <div class="modal-header">
                  <h5 class="modal-title">Edit User: {{ u.username }}</h5>
                  <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                  <div class="mb-3">
                    <label class="form-label">Name</label>
                    <input type="text" name="name" class="form-control" value="{{ u.name }}">
                  </div>
                  <div class="mb-3">
                    <label class="form-label">Role</label>
                    <select name="role" class="form-select">
                      <option value="staff" {{ 'selected' if u.role=='staff' }}>Staff</option>
                      <option value="manager" {{ 'selected' if u.role=='manager' }}>Manager</option>
                      <option value="admin" {{ 'selected' if u.role=='admin' }}>Admin</option>
                    </select>
                  </div>
                  <div class="mb-3">
                    <label class="form-label">Assigned Store</label>
                    <select name="store_id" class="form-select">
                      <option value="">HQ (All Stores)</option>
                      {% for s in stores %}
                      <option value="{{ s.id }}" {{ 'selected' if u.store_id == s.id }}>{{ s.name }}{% if s.is_warehouse %} (Warehouse){% endif %}</option>
                      {% endfor %}
                    </select>
                    <small class="text-muted">HQ = Access all stores. Selecting a store restricts to that store only.</small>
                  </div>
                  <div class="mb-3">
                    <label class="form-label">New Password <small class="text-muted">(leave blank to keep)</small></label>
                    <input type="password" name="new_password" class="form-control">
                  </div>
                </div>
                <div class="modal-footer">
                  <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                  <button type="submit" class="btn btn-primary">Save</button>
                </div>
              </form>
            </div>
          </div>
        </div>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>

<!-- 권한 설명 -->
<div class="card border-0 shadow-sm mt-3">
  <div class="card-body">
    <h6><i class="bi bi-info-circle me-1"></i>Permission Guide</h6>
    <div class="row">
      <div class="col-md-6">
        <table class="table table-sm table-bordered mb-0">
          <thead class="table-light"><tr><th>Setting</th><th>Access Scope</th></tr></thead>
          <tbody>
            <tr><td><code>store_id = NULL</code> (HQ)</td><td>All stores - Dashboard, Sales, Inventory for entire business</td></tr>
            <tr><td><code>store_id = X</code> (Branch)</td><td>Single store only - Dashboard, Sales, Inventory for assigned store</td></tr>
            <tr><td><code>role = Admin</code></td><td>Always all stores + User Management + Settings</td></tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>
{% endblock %}
