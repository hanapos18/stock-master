{% extends "base.html" %}
{% block title %}Repackaging - StockMaster{% endblock %}
{% block page_title %}Repackaging Rules{% endblock %}
{% block content %}
<div class="d-flex justify-content-between mb-3">
  <h5>Repackaging Rules</h5>
  <a href="{{ url_for('repackaging.create_rule') }}" class="btn btn-primary btn-sm"><i class="bi bi-plus-circle me-1"></i>New Rule</a>
</div>
<div class="card border-0 shadow-sm"><div class="table-responsive">
  <table class="table table-hover mb-0"><thead class="table-light"><tr>
    <th>Source Product</th><th>→</th><th>Target Product</th><th>Ratio</th><th>Actions</th>
  </tr></thead><tbody>
    {% for r in rules %}<tr>
      <td><code>{{ r.source_code }}</code> {{ r.source_name }} ({{ r.source_unit }})</td>
      <td><i class="bi bi-arrow-right text-primary"></i></td>
      <td><code>{{ r.target_code }}</code> {{ r.target_name }} ({{ r.target_unit }})</td>
      <td><span class="badge bg-info">1 → {{ r.ratio }}</span></td>
      <td>
        <button class="btn btn-sm btn-success" data-bs-toggle="modal" data-bs-target="#execModal{{ r.id }}"><i class="bi bi-play-fill me-1"></i>Execute</button>
        <a href="{{ url_for('repackaging.edit_rule', rule_id=r.id) }}" class="btn btn-sm btn-outline-primary">Edit</a>
        <form method="post" action="{{ url_for('repackaging.delete_rule', rule_id=r.id) }}" class="d-inline" onsubmit="return confirm('Deactivate this rule?')">
          <button class="btn btn-sm btn-outline-danger">Delete</button>
        </form>
      </td>
    </tr>
    <!-- Execute Modal -->
    <div class="modal fade" id="execModal{{ r.id }}" tabindex="-1"><div class="modal-dialog"><div class="modal-content">
      <form method="post" action="{{ url_for('repackaging.execute_rule', rule_id=r.id) }}">
      <div class="modal-header"><h5 class="modal-title">Execute Repackaging</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
      <div class="modal-body">
        <p><strong>{{ r.source_name }}</strong> ({{ r.source_unit }}) → <strong>{{ r.target_name }}</strong> ({{ r.target_unit }})</p>
        <p class="text-muted">Ratio: 1 source = {{ r.ratio }} target</p>
        <div class="mb-3">
          <label class="form-label">Source Quantity to Repackage</label>
          <input type="number" name="source_quantity" class="form-control" step="0.01" min="0.01" required
            onchange="this.closest('.modal-body').querySelector('.target-preview').textContent = (parseFloat(this.value) * {{ r.ratio }}).toFixed(4)">
        </div>
        <p>Target output: <strong class="target-preview text-success">0</strong> {{ r.target_unit }}</p>
      </div>
      <div class="modal-footer"><button type="submit" class="btn btn-success">Execute Repackaging</button></div>
      </form>
    </div></div></div>
    {% endfor %}
    {% if not rules %}<tr><td colspan="5" class="text-center text-muted py-3">No repackaging rules defined</td></tr>{% endif %}
  </tbody></table>
</div></div>

<div class="mt-3 p-3 bg-light rounded">
  <h6 class="mb-2"><i class="bi bi-info-circle me-1"></i>How Repackaging Works</h6>
  <ul class="small mb-0">
    <li><strong>Rule:</strong> Define a conversion from a bulk source product to a smaller target product (e.g., 10kg bag → 500g packs)</li>
    <li><strong>Ratio:</strong> How many target units are produced from 1 source unit (e.g., ratio=20 means 1kg → 20 × 50g)</li>
    <li><strong>Execute:</strong> Enter the source quantity to consume, and the target quantity is auto-calculated and added to inventory</li>
  </ul>
</div>
{% endblock %}
