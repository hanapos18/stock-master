{% extends "base.html" %}
{% block title %}{{ 'Edit' if rule else 'New' }} Repackaging Rule{% endblock %}
{% block page_title %}{{ 'Edit' if rule else 'New' }} Repackaging Rule{% endblock %}
{% block content %}
<div class="card border-0 shadow-sm" style="max-width:700px;">
  <div class="card-body">
    <form method="post">
      <div class="row g-3">
        <div class="col-12">
          <label class="form-label">Source Product (Bulk) *</label>
          <div class="position-relative">
            <input type="text" id="sourceSearch" class="form-control" placeholder="Search source product..." autocomplete="off"
              value="{{ rule.source_code ~ ' - ' ~ rule.source_name if rule else '' }}">
            <div id="sourceResults" class="product-search-results" style="display:none;"></div>
            <input type="hidden" name="source_product_id" id="sourceProductId" required
              value="{{ rule.source_product_id if rule else '' }}">
          </div>
        </div>
        <div class="col-12">
          <label class="form-label">Target Product (Split) *</label>
          <div class="position-relative">
            <input type="text" id="targetSearch" class="form-control" placeholder="Search target product..." autocomplete="off"
              value="{{ rule.target_code ~ ' - ' ~ rule.target_name if rule else '' }}">
            <div id="targetResults" class="product-search-results" style="display:none;"></div>
            <input type="hidden" name="target_product_id" id="targetProductId" required
              value="{{ rule.target_product_id if rule else '' }}">
          </div>
        </div>
        <div class="col-md-6">
          <label class="form-label">Conversion Ratio *</label>
          <input type="number" name="ratio" class="form-control" step="0.0001" min="0.0001" required
            value="{{ rule.ratio if rule else '' }}" placeholder="e.g., 20 (1 source = 20 target)">
          <small class="text-muted">How many target units from 1 source unit</small>
        </div>
      </div>
      <div class="mt-3">
        <button type="submit" class="btn btn-primary">Save Rule</button>
        <a href="{{ url_for('repackaging.list_rules') }}" class="btn btn-outline-secondary ms-2">Cancel</a>
      </div>
    </form>
  </div>
</div>

<div class="mt-3 p-3 bg-light rounded" style="max-width:700px;">
  <h6><i class="bi bi-lightbulb me-1"></i>Example</h6>
  <p class="mb-0 small">Source: <strong>Rice 10kg bag</strong> â†’ Target: <strong>Rice 500g pack</strong>, Ratio: <strong>20</strong><br>
  (1 bag of 10kg produces 20 packs of 500g each)</p>
</div>
{% endblock %}
{% block scripts %}
<script>
initProductSearch('sourceSearch', 'sourceResults', function(p) {
  document.getElementById('sourceProductId').value = p.id;
  document.getElementById('sourceSearch').value = p.code + ' - ' + p.name + ' (' + p.unit + ')';
});
initProductSearch('targetSearch', 'targetResults', function(p) {
  document.getElementById('targetProductId').value = p.id;
  document.getElementById('targetSearch').value = p.code + ' - ' + p.name + ' (' + p.unit + ')';
});
</script>
{% endblock %}
